<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>공지 관리</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>
    <link rel="stylesheet" href="/css/style.css"/>
    <style>
        #manageTable th, #manageTable td {
            font-size: 12px
        }

        .pill-outline {
            display: inline-flex;
            align-items: center;
            height: 24px;
            padding: 0 10px;
            border: 1px solid var(--gray-300);
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 700
        }

        .pill-pub {
            background: var(--navy-700);
            color: #fff
        }
    </style>
</head>
<body class="bg-page">
<div id="header"></div>
<main class="py-4">
    <div class="container-1200 d-flex gap-24">
        <div id="sidebar"></div>
        <section class="flex-1">
            <div class="d-flex justify-content-between align-items-center mb-12">
                <div class="fw-700 fs-5">공지 관리</div>
                <a class="btn btn-navy rounded-pill" href="ad-notice.html"><i class="bi bi-plus-circle me-1"></i> 새
                    공지</a>
            </div>

            <!-- 검색/필터 -->
            <div class="card-white p-20 mb-16">
                <form id="mFilter" class="row g-3">
                    <div class="col-12 col-md-4">
                        <input id="mq" type="text" class="form-control" placeholder="제목 / 작성자">
                    </div>
                    <div class="col-6 col-md-3">
                        <select id="mcat" class="form-select">
                            <option value="">분류(전체)</option>
                            <option value="학사">학사</option>
                            <option value="장학">장학</option>
                            <option value="행사">행사</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <select id="mstat" class="form-select">
                            <option value="">상태(전체)</option>
                            <option value="PUBLISHED">발행</option>
                            <option value="SCHEDULED">예약</option>
                            <option value="HIDDEN">숨김</option>
                            <option value="DRAFT">초안</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-2">
                        <button class="btn btn-navy rounded-pill w-100">검색</button>
                    </div>
                </form>
            </div>

            <!-- 목록 -->
            <div class="card-white p-20">
                <div class="d-flex justify-content-between align-items-center mb-12">
                    <div class="fw-700">공지 목록</div>
                    <div class="xsmall text-gray-500"><span id="mCount">0</span>건</div>
                </div>

                <div class="table-wrap">
                    <table class="table align-middle" id="manageTable">
                        <thead>
                        <tr>
                            <th style="width:90px">번호</th>
                            <th>제목</th>
                            <th style="width:120px">분류</th>
                            <th style="width:140px">작성자</th>
                            <th style="width:120px">게시일</th>
                            <th style="width:100px">상태</th>
                            <th class="text-end" style="width:180px">액션</th>
                        </tr>
                        </thead>
                        <tbody id="mBody"></tbody>
                    </table>
                </div>

                <div id="mEmpty" class="xsmall text-gray-500 mt-2" style="display:none;">검색 결과가 없습니다.</div>

                <nav class="mt-3">
                    <ul id="mPagination" class="pagination justify-content-center mb-0"></ul>
                </nav>
            </div>
        </section>
    </div>
</main>
<div id="footer"></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const M = [
        {id: 301, title: "2학기 수강신청 안내", category: "학사", author: "학사팀", status: "PUBLISHED", publishAt: "2025-08-21"},
        {id: 300, title: "장학금 신청 일정", category: "장학", author: "장학팀", status: "PUBLISHED", publishAt: "2025-08-15"},
        {id: 299, title: "가을 축제 개최", category: "행사", author: "총학생회", status: "SCHEDULED", publishAt: "2025-10-01"},
        {id: 298, title: "테스트(숨김)", category: "학사", author: "관리자", status: "HIDDEN", publishAt: "2025-08-10"},
        {id: 297, title: "임시 초안", category: "학사", author: "관리자", status: "DRAFT", publishAt: "2025-08-05"}
    ];
    const ms = {q: "", cat: "", stat: "", page: 1, size: 8, all: [...M], filtered: []};

    function badge(s) {
        if (s === "PUBLISHED") return '<span class="pill-pub pill-outline" style="border:none">발행</span>';
        if (s === "SCHEDULED") return '<span class="pill-outline">예약</span>';
        if (s === "HIDDEN") return '<span class="pill-outline">숨김</span>';
        return '<span class="pill-outline">초안</span>';
    }

    function mApply(e) {
        if (e) e.preventDefault();
        ms.q = $("#mq").val().trim().toLowerCase();
        ms.cat = $("#mcat").val();
        ms.stat = $("#mstat").val();

        ms.filtered = ms.all
            .filter(n => {
                const hitQ = !ms.q || n.title.toLowerCase().includes(ms.q) || (n.author || "").toLowerCase().includes(ms.q);
                const hitC = !ms.cat || n.category === ms.cat;
                const hitS = !ms.stat || n.status === ms.stat;
                return hitQ && hitC && hitS;
            })
            .sort((a, b) => b.id - a.id);

        ms.page = 1;
        mRender();
    }

    function mPage(list) {
        const s = (ms.page - 1) * ms.size;
        return list.slice(s, s + ms.size);
    }

    function mRender() {
        const $b = $("#mBody").empty();
        const total = ms.filtered.length;
        const pageTotal = Math.max(1, Math.ceil(total / ms.size));
        ms.page = Math.min(ms.page, pageTotal);
        const pageList = mPage(ms.filtered);

        $("#mCount").text(total);
        $("#mEmpty").toggle(total === 0);

        pageList.forEach((n, idx) => {
            const no = total - ((ms.page - 1) * ms.size + idx);
            $b.append(`
        <tr>
          <td>${no}</td>
          <td><a href="ad-notice.html?id=${n.id}" class="fw-700">${n.title}</a></td>
          <td>${n.category}</td>
          <td>${n.author || '-'}</td>
          <td>${n.publishAt || '-'}</td>
          <td>${badge(n.status)}</td>
          <td class="text-end">
  <div class="btn-group">
    <a class="btn btn-white btn-sm" href="ad-notice.html?id=${n.id}">편집</a>
    <button class="btn btn-white btn-sm btn-hide" data-id="${n.id}">
      ${n.status === "HIDDEN" ? "해제" : "숨김"}
    </button>
    <button class="btn btn-white btn-sm btn-del" data-id="${n.id}">삭제</button>
  </div>
</td>

        </tr>
      `);
        });

        mPaginate(pageTotal);
    }

    function mPaginate(pageTotal) {
        const $p = $("#mPagination").empty();
        const item = (label, page, disabled = false, active = false) => $(`
      <li class="page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}">
        <a class="page-link" href="#" data-page="${page}">${label}</a>
      </li>
    `);
        $p.append(item("&laquo;&laquo;", 1, ms.page === 1));
        const w = 2;
        let s = Math.max(1, ms.page - w), e = Math.min(pageTotal, ms.page + w);
        if (s > 1) {
            $p.append(item("1", 1, false, ms.page === 1));
            if (s > 2) $p.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
        }
        for (let i = s; i <= e; i++) $p.append(item(String(i), i, false, ms.page === i));
        if (e < pageTotal) {
            if (e < pageTotal - 1) $p.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
            $p.append(item(String(pageTotal), pageTotal, false, ms.page === pageTotal));
        }
        $p.append(item("&raquo;&raquo;", pageTotal, ms.page === pageTotal));
        $p.find("a.page-link").on("click", function (ev) {
            ev.preventDefault();
            const p = Number($(this).data("page"));
            if (!p || p === ms.page) return;
            ms.page = p;
            mRender();
        });
    }

    function toast(msg) {
        const id = "snack-" + Date.now();
        const el = $(`<div id="${id}" class="position-fixed bottom-0 start-50 translate-middle-x mb-3 px-3 py-2 rounded-pill text-white" style="background:#0F2940;z-index:1080;">${msg}</div>`);
        $("body").append(el);
        setTimeout(() => el.fadeOut(200, () => el.remove()), 1600);
    }

    $(function () {
        $("#mFilter").on("submit", mApply);
        $("#mBody").on("click", ".btn-hide", function () {
            const id = Number($(this).data("id"));
            const t = M.find(x => x.id === id);
            if (!t) return;

            if (t.status === "HIDDEN") {
                t.status = "PUBLISHED"; // 다시 발행
                toast("숨김 해제되었습니다.");
            } else {
                t.status = "HIDDEN";    // 숨김 처리
                toast("숨김 처리되었습니다.");
            }

            mApply();
        });

        $("#mBody").on("click", ".btn-del", function () {
            const id = Number($(this).data("id"));
            if (!confirm("삭제하시겠습니까?")) return;
            const idx = M.findIndex(x => x.id === id);
            if (idx > -1) M.splice(idx, 1);
            toast("삭제되었습니다.");
            mApply();
        });
        mApply();
    });
</script>
<script src="script/common-ui.js"></script>
<script src="script/app.js"></script>
<!-- ✅ 공통 include: static/mapper/... -->
<script>
    $(function () {
        $("#header").load("/mapper/header.html");
        $("#sidebar").load("/mapper/sidebar.html");
        $("#footer").load("/mapper/footer.html");
    });
</script>
</body>
</html>
